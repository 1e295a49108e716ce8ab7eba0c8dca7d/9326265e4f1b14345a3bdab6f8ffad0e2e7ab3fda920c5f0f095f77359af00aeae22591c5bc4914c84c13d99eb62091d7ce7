<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>.shortpie.'s UNDERTALE web port!</title>
    <base href="https://cdn.jsdelivr.net/gh/1e295a49108e716ce8ab7eba0c8dca7d/wowzas2@main/">
    <meta name="theme-color" content="#000000" />
    <link rel="stylesheet" href="./style.css" />
    <link rel="icon" href="./fav.ico" />
  </head>
  <body>
    <div class="container">
      <h2>welcome to</h2>
      <h1 class="shortpie">&nbsp;.shortpie.'s</h1>
      <br>
      <img style="margin: 0;" src="undertale_logo.jpg" alt="UNDERTALE" class="logo" />
      <h1 style="display: block; margin: 0;">web port!</h1>
      <img id="dog" class="toby" src="./toby/10thdog.png" alt="toby">
      <img class="toby10th" src="./toby/10thanniv.png" alt="toby">
      <audio id="audio-player" preload="auto"></audio>
      <script>
        if (history.scrollRestoration) {
          history.scrollRestoration = 'manual';
        }
      </script>
      <script>
        const dogElement = document.getElementById('dog');
        const audioPlayer = document.getElementById('audio-player');
        dogElement.addEventListener('mouseenter', () => {
          dogElement.src = './toby/10thdogmouth.png';
        });
        dogElement.addEventListener('mouseleave', () => {
          dogElement.src = './toby/10thdog.png';
        });
        dogElement.addEventListener('click', () => {
          audioPlayer.src = './toby/6.mp3';
          audioPlayer.play();
        });
      </script>
      <div class="button-group">
          <div id="chapterButtons" class="chapter-buttons">
            <button id="10th" class="chapter-button-3">
              <span class="button-label">10TH BATTLE</span>
            </button>
            <button id="play" class="chapter-button-1">
              <span class="button-label">START</span>
            </button>
            <button id="ostPlayerButton" class="chapter-button-2">
              <span class="button-label">OST PLAYER</span>
            </button>
          </div>
          <div id="chapterButtons" class="othersite-button">
            <button id="drweb" class="chapter-button-4">
              <span class="button-label">DELTARUNEWeb</span>
            </button>
            <button id="utyweb" class="chapter-button-4">
              <span class="button-label">UTYellowWeb</span>
            </button>
          </div>
      </div>
      <div class="toggle-container">
        <label for="offlineToggle">Offline Mode?</label>
        <label class="toggle-switch">
          <input type="checkbox" id="offlineToggle">
          <span class="slider"></span>
        </label>
      </div>
      <div id="cacheStatus">
        <img src="spinner.gif" id="cacheSpinnerGif" alt="Downloading...">
        <span id="cacheText"></span>
      </div>
      <div class="notes">
        <h2 class="notes-title">— UPDATE NOTES —</h2>
        <h4>version 14 LTS</h4>
        <ul style="font-family: '8BitOperator', sans-serif; font-size: 90%">
          <li class="update">Some bugs have been fixed that didn't allow you to use Shift and Control/Command as Cancel and Menu buttons!</li>
          <li class="update">There is now controller support! Any controller should now be plug-and-play so as soon as you connect a controller, you can use it! Have fun!</li>
          <li class="update">Added a new OST player, as well as added songs from UNDERTALE 10th Anniversary album/OST!</li>
          <li class="update">The game itself now looks better than before (thanks to the UT 10th Anniv. team for that!) using an updated canvas.</li>
          <li class="update">There is now an UNDERTALE Yellow port!! You can play it while online, and it has all of the same features as UTWeb.</li>
        </ul>
      </div>
      <h5 id="discord-link" style="font-size: 35px; margin-bottom: 14px; margin-top: 32px;">
          <br><a href="https://discord.gg/4nry3kY6Js" style="color: #5865F2;">The Discord server</a> is back and better than ever! Join for development updates and other projects!
      </h5>
      <iframe id="discord-widget" src="https://discord.com/widget?id=1417899899390791816&theme=dark" width="350" height="500" allowtransparency="true" frameborder="0" sandbox="allow-popups allow-popups-to-escape-sandbox allow-same-origin allow-scripts"></iframe>
      <footer class="disclaimer">
        <p>
          <strong style="font-size: 20px; color: #667;">DISCLAIMER:</strong>
          <br> This is a fan-made project for educational and archival purposes. All rights to <em>UNDERTALE</em>, are owned by Toby Fox, Materia Music Collective, 8-4 and any associated partners. <br> I do not claim ownership of any copyrighted material and do not profit from this project. <br> If you are the copyright holder and would like to discuss the topic of the content on this website, please contact me by emailing me at snappyshortpie@gmail.com or .shortpie. on Discord and I will respond as soon as possible. <br>
          <br> Please support the official release at <a href="https://undertale.com" target="_blank">undertale.com</a> whenever you have a chance!
        </p>
      </footer>
      <p>
        <strong style="font-size: 20px; color: #557;">base homepage made by </strong>
        <a href="https://github.com/aukak" style="font-size: 20px; color: #007bff; text-decoration: underline;">bog</a>
      </p>
      <div id="gameFrame" class="game-frame hidden"></div>
      <script>
          async function loadthingy(url) {
            try {
              const res = await fetch(url);
              if (!res.ok) throw new Error(`Failed to load ${url}`);
              const html = await res.text();
              document.documentElement.innerHTML = html;
              document.documentElement.querySelectorAll('script').forEach(oldScript => {
                const newScript = document.createElement('script');
                if (oldScript.src) {
                  newScript.src = oldScript.src;
                } else {
                  newScript.textContent = oldScript.textContent;
                }
                document.body.appendChild(newScript);
              });
            } catch (err) {
              console.error(err);
              alert("yo error or sm idk 🥀");
            }
          }
          
          const base = document.querySelector('base')?.href || window.location.origin;
          document.getElementById('10th').addEventListener('click', () =>
            loadthingy(`${base}utweb/10th/index.html`)
          );
          document.getElementById('play').addEventListener('click', () =>
            loadthingy(`${base}utweb/play/index.html`)
          );
          document.getElementById('ostPlayerButton').addEventListener('click', () =>
            loadthingy(`${base}utweb/music/index.html`)
          );
          document.getElementById('drweb').addEventListener('click', () =>
            loadthingy(`${base}drweb/index.html`)
          );
          document.getElementById('utyweb').addEventListener('click', () =>
            loadthingy(`${base}utyweb/index.html`)
          );
          
          // --- SELECTORS FOR BUTTONS AND OTHER ELEMENTS ---
          const DRWebButton = document.querySelector('.chapter-button-4');
          const ostPlayerButton = document.getElementById('ostPlayerButton');
          const discordLink = document.getElementById('discord-link');
          const discordWidget = document.getElementById('discord-widget');
          const offlineToggle = document.getElementById('offlineToggle');
          const cacheStatusText = document.getElementById('cacheText');
          const cacheSpinner = document.getElementById('cacheSpinnerGif');
          const toggleSwitch = document.querySelector('.toggle-switch');
          const CACHE_NAME = 'offlinemode';

          // --- CORE FUNCTIONS ---

          async function fetchFileList(url) {
            try {
              const response = await fetch(url);
              if (!response.ok) {
                console.error(`Failed to fetch file list: ${url}. Status: ${response.status}`);
                alert(`Could not download the file list from ${url}. This component may not work offline.`);
                return []; // Return an empty array on HTTP error
              }
              const text = await response.text();
              // Split by newline and filter out any empty lines
              return text.split('\n').map(line => line.trim()).filter(line => line.length > 0);
            } catch (error) {
              console.error(`Network error fetching file list from ${url}:`, error);
              alert(`A network error occurred while trying to download the file list from ${url}.`);
              return []; // Return an empty array on network error
            }
          }

          async function cacheFilesWithProgress(cache, fileList) {
            let failedFiles = [];
            const maxRetries = 3;
            for (let i = 0; i < fileList.length; i++) {
              const file = fileList[i];
              let success = false;
              for (let attempt = 1; attempt <= maxRetries; attempt++) {
                try {
                  cacheStatusText.textContent = `Downloading files: ${i + 1}/${fileList.length} (Attempt ${attempt}/3)...`;
                  await cache.add(file);
                  success = true;
                  break;
                } catch (error) {
                  console.warn(`Attempt ${attempt} failed for ${file}:`, error);
                  if (attempt === maxRetries) {
                    console.error(`All ${maxRetries} attempts failed for ${file}.`);
                  } else {
                    await new Promise(resolve => setTimeout(resolve, 1000));
                  }
                }
              }
              if (!success) {
                failedFiles.push(file);
              }
            }
            return failedFiles;
          }

          async function clearCacheAndReset() {
            await caches.delete(CACHE_NAME);
            localStorage.removeItem('ut_offlineModeEnabled');
            localStorage.removeItem('ut_offlineOstPlayer');
            offlineToggle.checked = false;
          }

          async function toggleOfflineMode() {
            const cacheStatusContainer = document.getElementById('cacheStatus');

            if (offlineToggle.checked) {
              // --- ENABLE OFFLINE MODE ---
              const isVerified = localStorage.getItem('underverif') === 'fea2fb654f17156a8393d060f5b8a2d3833fdf96325b698da7596c76a2d041e9';

              if (isVerified) {
                const wantsToEnable = confirm("Enabling Offline Mode will download files, allowing you to play on this site even if you're offline. Keep in mind that this will take some time, and that you will not receive updates until you disable and re-enable Offline Mode. Continue?");

                if (wantsToEnable) {
                  const wantsOstPlayer = confirm("Also download files for the OST PLAYER to use it offline?");

                  // Show the spinner and status text
                  offlineToggle.disabled = true;
                  cacheStatusContainer.style.display = 'flex';
                  cacheSpinner.style.display = 'inline-block';
                  toggleSwitch.classList.add('downloading');
                  cacheStatusText.textContent = 'Fetching file lists...';

                  // Fetch the file lists from your text files
                  let filesToCache = [];
                  const baseFiles = await fetchFileList('./cache/base.txt');

                  if (baseFiles.length === 0) {
                    alert("The base game file list could not be downloaded. Cannot enable Offline Mode.");
                    offlineToggle.checked = false;
                    offlineToggle.disabled = false;
                    cacheSpinner.style.display = 'none';
                    cacheStatusText.textContent = '';
                    toggleSwitch.classList.remove('downloading');
                    cacheStatusContainer.style.display = 'none';
                    return;
                  }
                  filesToCache.push(...baseFiles);
                  
                  if (wantsOstPlayer) {
                    const ostFiles = await fetchFileList('./cache/ostplayer.txt');
                    filesToCache.push(...ostFiles);
                  }

                  try {
                    const cache = await caches.open(CACHE_NAME);
                    const failedFiles = await cacheFilesWithProgress(cache, filesToCache);

                    if (failedFiles.length > 0) {
                      const wantsToProceed = confirm(`Offline Mode is partially enabled, but ${failedFiles.length} files failed to save. The site may not work correctly. Proceed anyway?`);
                      if (wantsToProceed) {
                        localStorage.setItem('ut_offlineModeEnabled', 'true');
                        localStorage.setItem('ut_offlineOstPlayer', wantsOstPlayer);
                        location.reload();
                      } else {
                        await clearCacheAndReset();
                        location.reload();
                      }
                    } else {
                      alert('All selected files cached successfully! Offline Mode is now enabled.');
                      localStorage.setItem('ut_offlineModeEnabled', 'true');
                      localStorage.setItem('ut_offlineOstPlayer', wantsOstPlayer);
                      location.reload();
                    }
                  } catch (error) {
                    console.error('A critical error occurred during caching:', error);
                    await clearCacheAndReset();
                  } finally {
                    offlineToggle.disabled = false;
                    cacheSpinner.style.display = 'none';
                    cacheStatusText.textContent = '';
                    toggleSwitch.classList.remove('downloading');
                    cacheStatusContainer.style.display = 'none';
                  }
                } else {
                  offlineToggle.checked = false;
                }
              } else {
                alert("You must verify ownership of UNDERTALE before enabling Offline Mode.");
                offlineToggle.checked = false;
                loadverif();
              }
            } else {
              // --- DISABLE OFFLINE MODE ---
              await clearCacheAndReset();
              alert('Offline Mode has been disabled and all locally saved files have been removed!');
              location.reload();
            }
          }

          function updateToggleState() {
              const utOfflineEnabled = localStorage.getItem('ut_offlineModeEnabled') === 'true';
              offlineToggle.checked = utOfflineEnabled;

              const UTYellowButton = document.querySelector('.chapter-button-5');
              const DRWebButton = document.querySelector('.chapter-button-4');

              // --- Handle UT Offline Mode ---
              if (utOfflineEnabled) {
                  DRWebButton.classList.add('button-disabled'); // UT disables DRWeb
                  discordLink.style.display = 'none';
                  discordWidget.style.display = 'none';

                  const ostPlayerCached = localStorage.getItem('ut_offlineOstPlayer') === 'true';
                  ostPlayerButton.disabled = !ostPlayerCached;
                  if (!ostPlayerCached) {
                      ostPlayerButton.title = "Not available offline. Re-enable Offline Mode and select this option.";
                      ostPlayerButton.classList.add('button-disabled');
                  }
              } else {
                  DRWebButton.classList.remove('button-disabled');
                  discordLink.style.display = 'block';
                  discordWidget.style.display = 'block';
                  ostPlayerButton.classList.remove('button-disabled');
                  ostPlayerButton.disabled = false;
                  ostPlayerButton.title = "";
              }

              // --- Handle DELTARUNEWeb Offline Mode ---
              const drOfflineExists = localStorage.getItem('dr_offlineModeEnabled') !== null;

              if (utOfflineEnabled && !drOfflineExists) {
                  DRWebButton.classList.add('button-disabled');
                  DRWebButton.disabled = true;
                  DRWebButton.title = "DELTARUNEWeb is not available offline. Enable Offline Mode while online to use it.";
              } else {
                  DRWebButton.classList.remove('button-disabled');
                  DRWebButton.disabled = false;
                  DRWebButton.title = "";
              }

              // --- Handle UTYellowWeb Offline Mode (always disabled when offline) ---
              if (utOfflineEnabled) {
                  UTYellowButton.classList.add('button-disabled');
                  UTYellowButton.disabled = true;
                  UTYellowButton.title = "UTYellowWeb is unavailable in Offline Mode.";
              } else {
                  UTYellowButton.classList.remove('button-disabled');
                  UTYellowButton.disabled = false;
                  UTYellowButton.title = "";
              }
          }

          if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
              navigator.serviceWorker.register('./sw.js', {
                scope: '../utweb/'
              })
              .then(() => console.log('Service Worker registered successfully!'))
              .catch(err => console.error('Service Worker registration failed:', err));
            });
          }

          updateToggleState();
          offlineToggle.addEventListener('change', toggleOfflineMode);
        </script>
  </body>
</html>

<!-- UNDERTALEWeb v14 LTS -->
<!-- made with ❤️ by breadbb, EnzuhhhhBR, Eliandro4 and .shortpie. -->
<!-- credits to Toby Fox for making UNDERTALE, we love you! -->
